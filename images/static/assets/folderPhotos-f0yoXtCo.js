var c=Object.defineProperty;var p=(a,t,e)=>t in a?c(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var n=(a,t,e)=>p(a,typeof t!="symbol"?t+"":t,e);import{C as g,L as f}from"./config-Cl7HKdRu.js";/* empty css              */import{U as P,I as u,P as m,a as d}from"./photoFilter-WowTT1ro.js";import"./utils-B3qE-N8V.js";import{f as h}from"./folder-cache-BkVv4j5s.js";const I=g.apiUrl;class E{constructor(){n(this,"photos",[]);n(this,"filteredPhotos",[]);n(this,"displayedPhotos",[]);n(this,"currentPhotoIndex",-1);n(this,"folderPath","");n(this,"folderName","");n(this,"uiService");n(this,"photoFilter");n(this,"PAGE_SIZE",100);n(this,"currentPage",1);n(this,"totalPages",0);this.init()}async init(){new f({title:"Folder Photos - Hachi",currentPage:"/folder-photos.html",showNavbar:!0}),this.initializeComponents(),this.uiService=new P("photo-grid-container"),this.extractFolderPath(),this.setupEventListeners(),await this.loadFolderPhotos()}initializeComponents(){u.initialize(),m.initialize("photo-grid-container",{loadingId:"loading-indicator",errorId:"error-display",noResultsId:"no-results-message",gridId:"photo-grid"}),this.photoFilter=new d({onFilterChange:e=>this.handleFilteredPhotosUpdate(e)});const t=document.getElementById("photo-filter-container");t&&(t.classList.remove("lg:block"),t.classList.add("hidden"),t.innerHTML=d.getTemplate("photo-filter"),this.photoFilter.initialize("photo-filter"))}extractFolderPath(){const e=new URLSearchParams(window.location.search).get("path");e?(this.folderPath=decodeURIComponent(e),this.folderName=this.getDisplayName(this.folderPath),this.updateHeader()):this.showError("No folder path specified")}getDisplayName(t){const e=t.split(/[/\\]/);return e[e.length-1]||t}updateHeader(){const t=document.getElementById("folder-name"),e=document.getElementById("folder-path");t&&(t.textContent=this.folderName),e&&(e.textContent=this.folderPath)}setupEventListeners(){const t=document.getElementById("back-btn");t&&t.addEventListener("click",()=>{window.location.href="/folders.html"}),this.setupMobileFilterToggle(),this.uiService.setupEventListeners({onPhotoClick:e=>this.handlePhotoClick(e),onModalClose:()=>this.closeModal(),onModalNext:()=>this.nextPhoto(),onModalPrevious:()=>this.previousPhoto()})}async loadFolderPhotos(){if(!this.folderPath){this.showError("No folder path specified");return}this.showLoading(!0),this.hideError();try{const t=this.folderPath.toString().toLowerCase().replace(/\//g,"|"),e=await fetch(`${I}/getMeta/resource_directory/${t}`);if(!e.ok)throw new Error(`Failed to fetch folder photos: ${e.status}`);const o=await e.json();if(o&&o.meta_data&&Array.isArray(o.meta_data)){this.photos=o.data_hash.map((i,r)=>({id:i,score:o.score[r]||0,metadata:o.meta_data[r]||{}})),this.filteredPhotos=[...this.photos],this.photoFilter.updatePhotos(this.photos),this.photoFilter.setResourceDirectory([this.folderPath]);const s=document.getElementById("photo-filter-container");s&&(this.photos.length>0?(s.classList.remove("hidden"),s.classList.add("lg:block")):(s.classList.remove("lg:block"),s.classList.add("hidden"))),this.updatePhotoCount(),this.updatePagination(),this.renderPhotos(),this.setupPaginationEventListeners(),this.updateFolderCache(o.data_hash[0]||void 0)}else throw new Error("Invalid response format")}catch(t){console.error("Error loading folder photos:",t),this.showError(`Failed to load photos: ${t instanceof Error?t.message:"Unknown error"}`)}finally{this.showLoading(!1)}}updatePhotoCount(){const t=document.getElementById("folder-photo-count");if(t){const e=this.photos.length,o=this.filteredPhotos.length;o===e?t.textContent=`${e} photo${e!==1?"s":""}`:t.textContent=`${o} of ${e} photo${e!==1?"s":""} (filtered)`}}updatePagination(){this.totalPages=Math.ceil(this.filteredPhotos.length/this.PAGE_SIZE);const t=(this.currentPage-1)*this.PAGE_SIZE,e=Math.min(t+this.PAGE_SIZE,this.filteredPhotos.length);this.displayedPhotos=this.filteredPhotos.slice(t,e),this.updatePaginationUI()}updatePaginationUI(){const t=document.getElementById("pagination-info");if(t){const r=(this.currentPage-1)*this.PAGE_SIZE+1,l=Math.min(this.currentPage*this.PAGE_SIZE,this.filteredPhotos.length);t.textContent=`Showing ${r}-${l} of ${this.filteredPhotos.length} photos`}const e=document.getElementById("prev-page-btn"),o=document.getElementById("next-page-btn"),s=document.getElementById("page-info");e&&(e.disabled=this.currentPage<=1),o&&(o.disabled=this.currentPage>=this.totalPages),s&&(s.textContent=`Page ${this.currentPage} of ${this.totalPages}`);const i=document.getElementById("pagination-container");i&&(this.totalPages>1?i.classList.remove("hidden"):i.classList.add("hidden"))}goToPage(t){t<1||t>this.totalPages||(this.currentPage=t,this.updatePagination(),this.renderPhotos(),window.scrollTo(0,0))}scrollToFilterLevel(){const t=document.getElementById("photo-filter-container"),e=document.querySelector("section"),o=t!=null&&t.classList.contains("lg:block")?t:e;o&&requestAnimationFrame(()=>{const s=o.getBoundingClientRect(),i=window.pageYOffset+s.top-20;window.scrollTo({top:i,behavior:"instant"})})}setupPaginationEventListeners(){var o,s;const t=document.getElementById("prev-page-btn"),e=document.getElementById("next-page-btn");if(t){const i=t.cloneNode(!0);(o=t.parentNode)==null||o.replaceChild(i,t),i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),i.disabled||this.goToPage(this.currentPage-1)})}if(e){const i=e.cloneNode(!0);(s=e.parentNode)==null||s.replaceChild(i,e),i.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),i.disabled||this.goToPage(this.currentPage+1)})}}renderPhotos(){const t=document.getElementById("photo-grid-container"),e=document.getElementById("no-photos");if(!(!t||!e)){if(this.filteredPhotos.length===0){t.innerHTML="",e.classList.remove("hidden");return}e.classList.add("hidden"),this.uiService.updatePhotos(this.displayedPhotos,o=>this.handlePhotoClick(o))}}handleFilteredPhotosUpdate(t){console.log("Filtered photos updated:",t.length),this.filteredPhotos=t,this.currentPage=1,this.updatePhotoCount(),this.updatePagination(),this.renderPhotos(),this.setupPaginationEventListeners()}handlePhotoClick(t){this.currentPhotoIndex=this.filteredPhotos.findIndex(e=>e.id===t.id),this.currentPhotoIndex!==-1&&this.openModal(t)}openModal(t){const e=this.currentPhotoIndex>0,o=this.currentPhotoIndex<this.filteredPhotos.length-1;this.uiService.showModal(t,e,o)}closeModal(){this.uiService.hideModal(),this.currentPhotoIndex=-1}nextPhoto(){if(this.currentPhotoIndex<this.filteredPhotos.length-1){this.currentPhotoIndex++;const t=this.filteredPhotos[this.currentPhotoIndex];this.openModal(t)}}previousPhoto(){if(this.currentPhotoIndex>0){this.currentPhotoIndex--;const t=this.filteredPhotos[this.currentPhotoIndex];this.openModal(t)}}showLoading(t){const e=document.getElementById("loading-indicator");e&&(t?(e.classList.remove("hidden"),e.classList.add("flex")):(e.classList.add("hidden"),e.classList.remove("flex")))}showError(t){const e=document.getElementById("error-message"),o=document.getElementById("error-text");e&&o&&(o.textContent=t,e.classList.remove("hidden"))}hideError(){const t=document.getElementById("error-message");t&&t.classList.add("hidden")}async updateFolderCache(t){try{const e=await h.getCachedFolder(this.folderPath);if(e)await h.updateFolderData(this.folderPath,{imageCount:this.photos.length,previewImageHash:t||e.previewImageHash}),console.log(`Updated cache for folder ${this.folderName}: ${this.photos.length} photos`);else{const o=this.getDisplayName(this.folderPath);await h.cacheFolderData([{name:o,fullPath:this.folderPath,imageCount:this.photos.length,previewImageHash:t,lastUpdated:Date.now()}]),console.log(`Created cache entry for folder ${this.folderName}: ${this.photos.length} photos`)}}catch(e){console.warn("Failed to update folder cache:",e)}}setupMobileFilterToggle(){const t=document.getElementById("mobile-filter-toggle"),e=document.getElementById("photo-filter-container");t&&e&&t.addEventListener("click",()=>{e.classList.toggle("hidden");const o=t.querySelector("svg:last-child");o&&o.classList.toggle("rotate-180")})}}const v=new E;window.folderPhotosApp=v;console.log("Folder photos page initialized");
