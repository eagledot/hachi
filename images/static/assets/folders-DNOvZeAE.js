var f=Object.defineProperty;var u=(h,e,t)=>e in h?f(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var l=(h,e,t)=>u(h,typeof e!="symbol"?e+"":e,t);import{C as p,L as w}from"./config-Cl7HKdRu.js";/* empty css              */import{f as d}from"./folder-cache-BkVv4j5s.js";import{h as m}from"./utils-B3qE-N8V.js";const c=p.apiUrl;new w({title:"Folders - Hachi",currentPage:"/folders.html",showNavbar:!0});class v{constructor(){l(this,"folders",[]);l(this,"filteredFolders",[]);l(this,"searchTerm","");l(this,"sortBy","name");l(this,"pageSize",20);l(this,"currentPage",1);l(this,"isLoading",!1);l(this,"imageErrorRetryCount",new Map);l(this,"MAX_RETRY_ATTEMPTS",2);this.setupEventListeners(),this.loadFolders()}setupEventListeners(){const e=document.getElementById("folder-search");e&&e.addEventListener("input",s=>{const o=s.target.value.toLowerCase();this.setSearchTerm(o)});const t=document.getElementById("sort-filter");t&&t.addEventListener("change",s=>{const o=s.target.value;this.sortFolders(o)});const r=document.getElementById("load-more-btn");r&&r.addEventListener("click",()=>{this.loadMoreFolders()});const a=document.getElementById("refresh-btn");a&&a.addEventListener("click",()=>{this.refreshFolders()})}async loadFolders(){this.isLoading=!0,this.showLoading(!0),this.hideError();try{if(await d.isCacheValid()){const t=await d.getCachedFolderData();if(t&&t.length>0){this.folders=t.map(s=>({name:this.getDisplayName(s.name),fullPath:s.fullPath,imageCount:s.imageCount,previewImage:s.previewImageHash?`${c}/getRawData/${s.previewImageHash}`:void 0})),this.filteredFolders=[...this.folders],this.sortFolders(this.sortBy),this.renderFolders(),this.isLoading=!1,this.showLoading(!1);const r=await d.getCacheStats(),a=Date.now()-60*60*1e3;r.lastUpdated&&r.lastUpdated<a&&this.refreshFoldersInBackground();return}}await this.loadFoldersFromAPI()}catch(e){console.error("Error in loadFolders:",e);try{await this.loadFoldersFromAPI()}catch(t){console.error("Error loading folders from API:",t),this.showError(`Failed to load folders: ${t instanceof Error?t.message:"Unknown error"}`)}}finally{this.isLoading=!1,this.showLoading(!1)}}async loadFoldersFromAPI(){const e=await fetch(`${c}/getGroup/resource_directory`);if(!e.ok)throw new Error(`Failed to fetch folders: ${e.status}`);const t=await e.json();if(Array.isArray(t))this.imageErrorRetryCount.clear(),this.folders=t.map(r=>({name:this.getDisplayName(r),fullPath:r,imageCount:0,previewImage:void 0})),await this.loadFolderPreviews(),await this.cacheFolderData(),this.filteredFolders=[...this.folders],this.sortFolders(this.sortBy),this.renderFolders();else throw new Error("Invalid response format")}async refreshFoldersInBackground(){try{const e=await fetch(`${c}/getGroup/resource_directory`);if(!e.ok){console.warn("Background refresh failed:",e.status);return}const t=await e.json();if(!Array.isArray(t)){console.warn("Invalid response format in background refresh");return}const r=t.map(s=>({name:this.getDisplayName(s),fullPath:s,imageCount:0,previewImage:void 0}));await this.loadFolderPreviewsForList(r);const a=r.map(s=>({name:s.name,fullPath:s.fullPath,imageCount:s.imageCount,previewImageHash:s.previewImage&&s.previewImage.split("/").pop()||void 0,lastUpdated:Date.now()}));await d.cacheFolderData(a)}catch(e){console.warn("Background refresh failed:",e)}}async cacheFolderData(){if(d.isIndexingInProgress()){console.warn("Skipping cache update while indexing is in progress");return}try{const e=this.folders.map(t=>({name:t.name,fullPath:t.fullPath,imageCount:t.imageCount,previewImageHash:t.previewImage&&t.previewImage.split("/").pop()||void 0,lastUpdated:Date.now()}));await d.cacheFolderData(e)}catch(e){console.warn("Failed to cache folder data:",e)}}async loadFolderPreviews(){for(let t=0;t<this.folders.length;t+=5){const r=this.folders.slice(t,t+5);await Promise.allSettled(r.map(async a=>{try{const s=a.fullPath.toString().toLowerCase().replace(/\//g,"|"),o=await fetch(`${c}/getMeta/resource_directory/${s}`);if(o.ok){const i=await o.json();if(i&&i.meta_data&&Array.isArray(i.meta_data)&&(a.imageCount=i.meta_data.length,i.data_hash&&i.data_hash.length>0)){const n=i.data_hash[0];n&&(a.previewImage=`${c}/getRawData/${n}`)}}else console.warn(`Failed to fetch preview for ${a.name}: ${o.status} ${o.statusText}`)}catch(s){console.error(`Error loading preview for folder ${a.name}:`,s)}})),this.renderFolders()}}async loadFolderPreviewsForList(e){for(let r=0;r<e.length;r+=5){const a=e.slice(r,r+5);await Promise.allSettled(a.map(async s=>{try{const o=s.fullPath.toString().toLowerCase().replace(/\//g,"|"),i=await fetch(`${c}/getMeta/resource_directory/${o}`);if(i.ok){const n=await i.json();if(n&&n.meta_data&&Array.isArray(n.meta_data)&&(s.imageCount=n.meta_data.length,n.data_hash&&n.data_hash.length>0)){const g=n.data_hash[0];g&&(s.previewImage=`${c}/getRawData/${g}`)}}}catch(o){console.error(`Error loading preview for folder ${s.name}:`,o)}}))}}getDisplayName(e){const t=e.split(/[/\\]/);return t[t.length-1]||e}setSearchTerm(e){this.searchTerm=e,this.filterFolders(),this.renderFolders()}filterFolders(){if(!this.searchTerm){this.filteredFolders=[...this.folders];return}this.filteredFolders=this.folders.filter(e=>e.name.toLowerCase().includes(this.searchTerm)||e.fullPath.toLowerCase().includes(this.searchTerm))}sortFolders(e){this.sortBy=e,this.filteredFolders.sort((t,r)=>{switch(e){case"photos":return r.imageCount-t.imageCount;case"name":default:return t.name.localeCompare(r.name)}}),this.renderFolders()}renderFolders(){const e=document.getElementById("folders-grid"),t=document.getElementById("no-folders");if(!e||!t)return;if(this.filteredFolders.length===0&&!this.isLoading){e.classList.add("hidden"),t.classList.remove("hidden");return}else if(this.filteredFolders.length===0&&this.isLoading){e.classList.add("hidden"),t.classList.add("hidden");return}t.classList.add("hidden"),e.classList.remove("hidden"),e.className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4";const r=0,a=this.currentPage*this.pageSize,s=this.filteredFolders.slice(r,a);e.innerHTML=s.map(o=>this.renderFolderCard(o)).join(""),this.updateLoadMoreButton(),this.setupFolderClickHandlers()}renderFolderCard(e){return this.renderGridViewCard(e)}renderGridViewCard(e){const t=e.previewImage?m`<img loading="lazy" src="${e.previewImage}" alt="${e.name}" class="w-full h-48 object-cover" onerror="foldersApp.handleImageError('${e.fullPath}', this)">`:m`<div class="w-full h-48 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
           <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
           </svg>
         </div>`;return`
      <div class="folder-card bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 hover:shadow-lg transition-all duration-300 cursor-pointer group relative" 
           data-folder-path="${encodeURIComponent(e.fullPath)}">
        ${t}
        
        <!-- Overlay with folder info -->
        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-2.5">
          <h3 class="font-semibold text-white text-xs leading-tight mb-1 line-clamp-2" title="${e.name}">
            ${e.name}
          </h3>
          <div class="flex items-center justify-between text-xs">
            <span class="text-gray-200 text-xs">
              ${e.imageCount>0?`${e.imageCount} photo${e.imageCount!==1?"s":""}`:"Loading..."}
            </span>
            <svg class="w-3 h-3 text-white/60 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </div>
        
        <!-- Hover indicator -->
        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-all duration-300 flex items-center justify-center">
          <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white/90 backdrop-blur-sm rounded-full p-1.5">
            <svg class="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
          </div>
        </div>
      </div>
    `}setupFolderClickHandlers(){document.querySelectorAll(".folder-card").forEach(t=>{t.addEventListener("click",()=>{const r=t.getAttribute("data-folder-path");r&&(window.location.href=`/folder-photos.html?path=${r}`)})})}loadMoreFolders(){this.currentPage++,this.renderFolders()}updateLoadMoreButton(){const e=document.getElementById("load-more-container");if(!e)return;this.currentPage*this.pageSize<this.filteredFolders.length?e.classList.remove("hidden"):e.classList.add("hidden")}showLoading(e){const t=document.getElementById("loading-indicator");t&&(e?(t.classList.remove("hidden"),t.classList.add("flex")):(t.classList.add("hidden"),t.classList.remove("flex")))}showError(e){const t=document.getElementById("error-message"),r=document.getElementById("error-text");t&&r&&(r.textContent=e,t.classList.remove("hidden"))}hideError(){const e=document.getElementById("error-message");e&&e.classList.add("hidden")}async refreshFolders(){const e=document.getElementById("refresh-btn"),t=document.getElementById("refresh-icon");e&&(e.disabled=!0,e.classList.add("opacity-50","cursor-not-allowed")),t&&t.classList.add("animate-spin"),this.showLoading(!0),this.hideError(),this.isLoading=!0;try{await d.clearCache(),console.log("Folder cache cleared successfully"),this.imageErrorRetryCount.clear(),this.folders=[],this.filteredFolders=[],this.currentPage=1,this.updateLoadMoreButton(),await this.loadFoldersFromAPI()}catch(r){console.error("Error refreshing folders:",r),this.showError(`Failed to refresh folders: ${r instanceof Error?r.message:"Unknown error"}`)}finally{this.isLoading=!1,this.showLoading(!1),e&&(e.disabled=!1,e.classList.remove("opacity-50","cursor-not-allowed")),t&&t.classList.remove("animate-spin")}}handleImageError(e,t){console.warn(`Image failed to load for folder: ${e}`),this.showImagePlaceholder(t);const r=this.imageErrorRetryCount.get(e)||0;if(r>=this.MAX_RETRY_ATTEMPTS){console.log(`Max retry attempts reached for folder: ${e}`);return}this.imageErrorRetryCount.set(e,r+1),r===0&&this.refreshFolders()}showImagePlaceholder(e){var r;e.style.display="none";const t=document.createElement("div");t.className="w-full h-48 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center",t.innerHTML=`
      <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
      </svg>
    `,(r=e.parentNode)==null||r.insertBefore(t,e)}}const y=new v;window.foldersApp=y;
