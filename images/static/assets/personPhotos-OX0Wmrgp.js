var p=Object.defineProperty;var m=(d,t,e)=>t in d?p(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var r=(d,t,e)=>m(d,typeof t!="symbol"?t+"":t,e);import{C as u,L as P}from"./config-C3qbAENF.js";import{U as g,I as f,P as I,a as l}from"./photoFilter-Cn5TW9Pc.js";import"./utils-B3qE-N8V.js";const h=u.apiUrl;class c{constructor(){r(this,"uiService");r(this,"personId",null);r(this,"personPhotosData",null);r(this,"currentPhotoIndex",null);r(this,"photoFilter");r(this,"allPhotos",[]);r(this,"filteredPhotos",[]);r(this,"displayedPhotos",[]);r(this,"PAGE_SIZE",100);r(this,"currentPage",1);r(this,"totalPages",0);this.init()}async init(){if(new P({title:"Person Photos - Hachi",currentPage:"person-photos"}),this.initializeComponents(),this.uiService=new g("photo-grid-container"),this.personId=this.getPersonIdFromUrl(),!this.personId){this.showError("No person ID specified");return}this.setupEventListeners(),await this.loadPersonData()}initializeComponents(){f.initialize(),I.initialize("photo-grid-container",{loadingId:"loading-indicator",errorId:"error-display",noResultsId:"no-results-message",gridId:"photo-grid",personMode:!0}),this.photoFilter=new l({onFilterChange:e=>this.handleFilteredPhotosUpdate(e)});const t=document.getElementById("photo-filter-container");t&&(t.classList.add("hidden"),t.innerHTML=l.getTemplate("photo-filter"),this.photoFilter.initialize("photo-filter"))}getPersonIdFromUrl(){return new URLSearchParams(window.location.search).get("id")}setupEventListeners(){const t=document.getElementById("back-btn");t&&t.addEventListener("click",()=>{window.location.href="/people.html"});const e=document.getElementById("edit-name-btn");e&&e.addEventListener("click",()=>this.showEditForm());const o=document.getElementById("save-name-btn");o&&o.addEventListener("click",()=>this.savePersonName());const s=document.getElementById("cancel-edit-btn");s&&s.addEventListener("click",()=>this.hideEditForm());const n=document.getElementById("person-name-input");n&&n.addEventListener("keydown",a=>{a.key==="Enter"?(a.preventDefault(),this.savePersonName()):a.key==="Escape"&&(a.preventDefault(),this.hideEditForm())});const i=document.getElementById("person-name-display");i&&i.addEventListener("click",()=>this.showEditForm()),this.uiService.setupEventListeners({onPhotoClick:a=>this.handlePhotoClick(a),onModalClose:()=>this.closeModal(),onModalNext:()=>this.nextPhoto(),onModalPrevious:()=>this.previousPhoto()})}async loadPersonData(){if(this.personId){this.showLoading(!0);try{const t=await fetch(`${h}/getMeta/person/${this.personId}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);this.personPhotosData=await t.json(),this.updatePersonInfo(),this.renderPhotos()}catch(t){console.error("Failed to load person data:",t),this.showError("Failed to load person data. Please try again.")}finally{this.showLoading(!1)}}}updatePersonInfo(){if(!this.personId||!this.personPhotosData)return;const t=document.getElementById("person-avatar");t&&(t.src=`${h}/getPreviewPerson/${this.personId}`,t.alt=this.personId,t.onerror=()=>{t.src="./assets/sample_place_bg.jpg"});const e=document.getElementById("person-name");if(e){const n=this.personId.charAt(0).toUpperCase()+this.personId.slice(1).toLowerCase();e.textContent=n}const o=document.getElementById("person-photo-count");if(o){const n=this.personPhotosData.data_hash?this.personPhotosData.data_hash.length:0;o.textContent=`${n} photos`}const s=document.getElementById("person-name-input");if(s){const n=this.personId.charAt(0).toUpperCase()+this.personId.slice(1).toLowerCase();s.value=n}}showEditForm(){const t=document.getElementById("person-name-display"),e=document.getElementById("person-name-edit"),o=document.getElementById("person-name-input");t&&e&&o&&(t.classList.add("hidden"),e.classList.remove("hidden"),o.focus(),o.select())}hideEditForm(){const t=document.getElementById("person-name-display"),e=document.getElementById("person-name-edit"),o=document.getElementById("person-name-input");if(t&&e&&o&&(t.classList.remove("hidden"),e.classList.add("hidden"),this.personId)){const s=this.personId.charAt(0).toUpperCase()+this.personId.slice(1).toLowerCase();o.value=s}}renderPhotos(){const t=document.getElementById("photo-grid"),e=document.getElementById("no-results-message");if(!t||!e||!this.personPhotosData)return;if(!this.personPhotosData.data_hash||this.personPhotosData.data_hash.length===0){t.innerHTML="",e.classList.remove("hidden");return}e.classList.add("hidden");const o=this.personPhotosData.data_hash.map((n,i)=>({id:n,score:this.personPhotosData.score[i]||0,metadata:this.personPhotosData.meta_data[i]||{}}));this.allPhotos=o,this.filteredPhotos=[...this.allPhotos],this.photoFilter.updatePhotos(this.allPhotos),this.personId&&this.photoFilter.setPersonContext(this.personId);const s=document.getElementById("photo-filter-container");s&&(this.allPhotos.length>0?(s.classList.remove("hidden"),s.classList.add("lg:block")):(s.classList.remove("lg:block"),s.classList.add("hidden"))),this.updatePagination(),this.renderDisplayedPhotos(),this.setupPaginationEventListeners()}updatePagination(){this.totalPages=Math.ceil(this.filteredPhotos.length/this.PAGE_SIZE);const t=(this.currentPage-1)*this.PAGE_SIZE,e=Math.min(t+this.PAGE_SIZE,this.filteredPhotos.length);this.displayedPhotos=this.filteredPhotos.slice(t,e),this.updatePaginationUI()}updatePaginationUI(){const t=document.getElementById("pagination-info");if(t){const i=(this.currentPage-1)*this.PAGE_SIZE+1,a=Math.min(this.currentPage*this.PAGE_SIZE,this.filteredPhotos.length);t.textContent=`Showing ${i}-${a} of ${this.filteredPhotos.length} photos`}const e=document.getElementById("prev-page-btn"),o=document.getElementById("next-page-btn"),s=document.getElementById("page-info");e&&(e.disabled=this.currentPage<=1),o&&(o.disabled=this.currentPage>=this.totalPages),s&&(s.textContent=`Page ${this.currentPage} of ${this.totalPages}`);const n=document.getElementById("pagination-container");n&&(this.totalPages>1?n.classList.remove("hidden"):n.classList.add("hidden"))}goToPage(t){t<1||t>this.totalPages||(this.currentPage=t,this.updatePagination(),this.renderDisplayedPhotos(),window.scrollTo(0,0))}scrollToFilterLevel(){const t=document.getElementById("photo-filter-container"),e=document.querySelector("section"),o=t!=null&&t.classList.contains("lg:block")?t:e;o&&requestAnimationFrame(()=>{const s=o.getBoundingClientRect(),n=window.pageYOffset+s.top-20;window.scrollTo({top:n,behavior:"instant"})})}setupPaginationEventListeners(){var o,s;const t=document.getElementById("prev-page-btn"),e=document.getElementById("next-page-btn");if(t){const n=t.cloneNode(!0);(o=t.parentNode)==null||o.replaceChild(n,t),n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),n.disabled||this.goToPage(this.currentPage-1)})}if(e){const n=e.cloneNode(!0);(s=e.parentNode)==null||s.replaceChild(n,e),n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),n.disabled||this.goToPage(this.currentPage+1)})}}renderDisplayedPhotos(){this.uiService.updatePhotos(this.displayedPhotos,t=>{this.handlePhotoClick(t)})}handleFilteredPhotosUpdate(t){console.log("Filtered photos updated:",t.length),this.filteredPhotos=t,this.currentPage=1,this.updatePagination(),this.renderDisplayedPhotos(),this.setupPaginationEventListeners()}handlePhotoClick(t){if(!this.personPhotosData)return;const e=this.filteredPhotos.findIndex(n=>n.id===t.id);if(e===-1)return;this.currentPhotoIndex=e;const o=e>0,s=e<this.filteredPhotos.length-1;this.uiService.showModal(t,o,s)}closeModal(){this.uiService.hideModal(),this.currentPhotoIndex=null}nextPhoto(){this.currentPhotoIndex!==null&&this.currentPhotoIndex<this.filteredPhotos.length-1&&(this.currentPhotoIndex++,this.showPhotoAtIndex(this.currentPhotoIndex))}previousPhoto(){this.currentPhotoIndex!==null&&this.currentPhotoIndex>0&&(this.currentPhotoIndex--,this.showPhotoAtIndex(this.currentPhotoIndex))}showPhotoAtIndex(t){if(t<0||t>=this.filteredPhotos.length)return;const e=this.filteredPhotos[t];this.currentPhotoIndex=t;const o=t>0,s=t<this.filteredPhotos.length-1;this.uiService.showModal(e,o,s)}async savePersonName(){if(!this.personId)return;const t=document.getElementById("person-name-input");if(!t)return;const e=t.value.trim();if(!e){this.showError("Please enter a valid name");return}if(e===this.personId){this.hideEditForm();return}const o=document.getElementById("save-name-btn"),s=document.getElementById("cancel-edit-btn");o&&s&&(o.disabled=!0,s.disabled=!0,o.classList.add("opacity-50","cursor-not-allowed"),s.classList.add("opacity-50","cursor-not-allowed"));try{const n=await this.renamePersonGlobally(this.personId,e);if(n.success){console.log(`Person name updated from ${this.personId} to: ${e}`);const i=`/person-photos.html?id=${encodeURIComponent(e)}`;window.location.href=i}else this.showError(n.reason||"Failed to save name. Please try again."),o&&s&&(o.disabled=!1,s.disabled=!1,o.classList.remove("opacity-50","cursor-not-allowed"),s.classList.remove("opacity-50","cursor-not-allowed"))}catch(n){console.error("Failed to save person name:",n),this.showError(n instanceof Error?n.message:"Failed to save name. Please try again."),o&&s&&(o.disabled=!1,s.disabled=!1,o.classList.remove("opacity-50","cursor-not-allowed"),s.classList.remove("opacity-50","cursor-not-allowed"))}}async renamePersonGlobally(t,e){const o=new FormData;o.append("old_person_id",t),o.append("new_person_id",e);try{const s=await fetch(`${h}/tagPerson`,{method:"POST",body:o});if(!s.ok){const i=await s.json().catch(()=>({reason:"Network error or invalid JSON response"}));throw new Error(i.reason||`Error ${s.status}: ${s.statusText}`)}const n=await s.json();return{success:n.success||!1,reason:n.reason}}catch(s){throw console.error("Error renaming person:",s),s}}showLoading(t){const e=document.getElementById("loading-indicator"),o=document.getElementById("photo-grid");e&&(t?(e.classList.remove("hidden"),e.classList.add("flex")):(e.classList.add("hidden"),e.classList.remove("flex"))),o&&t&&(o.innerHTML="")}showError(t){const e=document.getElementById("error-display"),o=document.getElementById("error-text");e&&o&&(o.textContent=t,e.classList.remove("hidden"),setTimeout(()=>{e.classList.add("hidden")},5e3))}}document.addEventListener("DOMContentLoaded",()=>{new c});window.personPhotosApp=c;
