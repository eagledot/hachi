var p=Object.defineProperty;var m=(d,e,t)=>e in d?p(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var a=(d,e,t)=>m(d,typeof e!="symbol"?e+"":e,t);import{C as u,L as P,q as g,d as f,e as l,f as I}from"./utils-CWqqr369.js";import{U as y,I as E,P as w}from"./photoGrid-21K76TKL.js";import{P as v}from"./photoFilter-BPDcR0DG.js";import{P as L}from"./pagination-TDJLyXTr.js";u.apiUrl;class c{constructor(){a(this,"uiService");a(this,"personId",null);a(this,"personPhotosData",null);a(this,"currentPhotoIndex",null);a(this,"photoFilter");a(this,"allPhotos",[]);a(this,"filteredPhotos",[]);a(this,"displayedPhotos",[]);a(this,"PAGE_SIZE",100);a(this,"currentPage",1);a(this,"paginationComponent");a(this,"queryToken",null);a(this,"imageWidth",0);a(this,"imageHeight",0);this.findGallerySize(),this.init()}findGallerySize(){const e=window.innerHeight,t=window.innerWidth,o=document.getElementById("photo-gallery"),s=o==null?void 0:o.clientHeight;console.log(`Photo gallery height: ${s}px`);const n=o==null?void 0:o.clientWidth;let i=6;t<640?i=2:t<768?i=3:t<1024?i=4:t<1280&&(i=5);const r=n/i;this.imageWidth=r-8,console.log(`Calculated photo width: ${this.imageWidth}px`);let h=4;e<640?h=2:e<768?h=3:e<1024?h=4:e<1280&&(h=5),this.imageHeight=s/h-8,console.log(`Calculated photo height: ${this.imageHeight}px`),this.PAGE_SIZE=h*i,console.log(`Calculated results per page: ${this.PAGE_SIZE}`)}async init(){if(new P({title:"Person Photos - Hachi",currentPage:"person-photos"}),this.initializeComponents(),this.uiService=new y("photo-grid-container",this.imageHeight,this.imageWidth,this.PAGE_SIZE),this.personId=this.getPersonIdFromUrl(),!this.personId){this.showError("No person ID specified");return}this.setupEventListeners(),this.setupPagination(),await this.loadPersonData()}initializeComponents(){E.initialize(),w.initialize("photo-grid-container",{loadingId:"loading-indicator",errorId:"error-display",noResultsId:"no-results-message",gridId:"photo-grid",personMode:!0}),this.photoFilter=new v({onFilterChange:e=>this.handleFilteredPhotosUpdate(e)})}getPersonIdFromUrl(){return new URLSearchParams(window.location.search).get("id")}setupEventListeners(){const e=document.getElementById("back-btn");e&&e.addEventListener("click",()=>{window.history.back()});const t=document.getElementById("edit-name-btn");t&&t.addEventListener("click",()=>this.showEditForm());const o=document.getElementById("save-name-btn");o&&o.addEventListener("click",()=>this.savePersonName());const s=document.getElementById("cancel-edit-btn");s&&s.addEventListener("click",()=>this.hideEditForm());const n=document.getElementById("person-name-input");n&&n.addEventListener("keydown",r=>{r.key==="Enter"?(r.preventDefault(),this.savePersonName()):r.key==="Escape"&&(r.preventDefault(),this.hideEditForm())});const i=document.getElementById("person-name-display");i&&i.addEventListener("click",()=>this.showEditForm()),this.uiService.setupEventListeners({onPhotoClick:r=>this.handlePhotoClick(r),onModalClose:()=>this.closeModal(),onModalNext:()=>this.nextPhoto(),onModalPrevious:()=>this.previousPhoto()})}async loadPersonData(){var e;if(console.log("Calling loadPersonData()"),!!this.personId)try{if(!this.personPhotosData){const o=await g("person",this.personId,this.PAGE_SIZE);(e=this.paginationComponent)==null||e.update({totalItems:o.n_matches,totalPages:o.n_pages}),console.log("Pagination Info:",o),this.queryToken=o.query_token||null}if(!this.queryToken)return;const t=await f(this.queryToken,this.currentPage-1);if(!t){this.showError("No photos found for this person");return}this.personPhotosData=t,console.log("Collected Person Photos:",this.personPhotosData),this.updatePersonInfo(),this.renderPhotos(),this.renderDisplayedPhotos()}catch(t){console.error("Failed to load person data:",t),this.showError("Failed to load person data. Please try again.")}finally{}}updatePersonInfo(){if(!this.personId||!this.personPhotosData)return;const e=document.getElementById("person-avatar");e&&(e.src=`${l.GET_PERSON_IMAGE}/${this.personId}`,e.alt=this.personId,e.onerror=()=>{e.src="./assets/sample_place_bg.jpg"});const t=document.getElementById("person-name");if(t){const n=this.personId.charAt(0).toUpperCase()+this.personId.slice(1).toLowerCase();t.textContent=n}const o=document.getElementById("person-photo-count");if(o){const n=this.personPhotosData.data_hash?this.personPhotosData.data_hash.length:0;o.textContent=`${n} photos`}const s=document.getElementById("person-name-input");if(s){const n=this.personId.charAt(0).toUpperCase()+this.personId.slice(1).toLowerCase();s.value=n}}showEditForm(){const e=document.getElementById("person-name-display"),t=document.getElementById("person-name-edit"),o=document.getElementById("person-name-input");e&&t&&o&&(e.classList.add("hidden"),t.classList.remove("hidden"),o.focus(),o.select())}hideEditForm(){const e=document.getElementById("person-name-display"),t=document.getElementById("person-name-edit"),o=document.getElementById("person-name-input");if(e&&t&&o&&(e.classList.remove("hidden"),t.classList.add("hidden"),this.personId)){const s=this.personId.charAt(0).toUpperCase()+this.personId.slice(1).toLowerCase();o.value=s}}renderPhotos(){const e=document.getElementById("photo-grid"),t=document.getElementById("no-results-message");if(!e||!t||!this.personPhotosData)return;if(!this.personPhotosData.data_hash||this.personPhotosData.data_hash.length===0){e.innerHTML="",t.classList.remove("hidden");return}t.classList.add("hidden");const o=this.personPhotosData.data_hash.map((n,i)=>({id:n,score:this.personPhotosData.score[i]||0,metadata:this.personPhotosData.meta_data[i]||{}}));this.allPhotos=o,this.filteredPhotos=[...this.allPhotos];const s=document.getElementById("photo-filter-container");s&&(this.allPhotos.length>0?(s.classList.remove("hidden"),s.classList.add("lg:block")):(s.classList.remove("lg:block"),s.classList.add("hidden")))}setupPagination(){console.log("Setting up pagination");const e=document.getElementById("pagination-container");if(!e){console.warn("Pagination container not found");return}e.innerHTML="",this.paginationComponent=new L({container:e,totalItems:this.filteredPhotos.length,itemsPerPage:this.PAGE_SIZE,initialPage:0,onPageChange:t=>{this.currentPage=t+1,this.loadPersonData()}}),this.currentPage=1}renderDisplayedPhotos(){console.log("Rendering displayed photos",this.filteredPhotos),this.displayedPhotos=[...this.filteredPhotos],this.uiService.updatePhotos(this.displayedPhotos)}handleFilteredPhotosUpdate(e){console.log("Filtered photos updated",e),this.filteredPhotos=e,this.currentPage=1,this.renderDisplayedPhotos()}handlePhotoClick(e){if(!this.personPhotosData)return;const t=this.filteredPhotos.findIndex(n=>n.id===e.id);if(t===-1)return;this.currentPhotoIndex=t;const o=t>0,s=t<this.filteredPhotos.length-1;this.uiService.showModal(e,o,s)}closeModal(){this.uiService.hideModal(),this.currentPhotoIndex=null}nextPhoto(){this.currentPhotoIndex!==null&&this.currentPhotoIndex<this.filteredPhotos.length-1&&(this.currentPhotoIndex++,this.showPhotoAtIndex(this.currentPhotoIndex))}previousPhoto(){this.currentPhotoIndex!==null&&this.currentPhotoIndex>0&&(this.currentPhotoIndex--,this.showPhotoAtIndex(this.currentPhotoIndex))}showPhotoAtIndex(e){if(e<0||e>=this.filteredPhotos.length)return;const t=this.filteredPhotos[e];this.currentPhotoIndex=e;const o=e>0,s=e<this.filteredPhotos.length-1;this.uiService.showModal(t,o,s)}async savePersonName(){if(!this.personId)return;const e=document.getElementById("person-name-input");if(!e)return;const t=e.value.trim();if(!t){this.showError("Please enter a valid name");return}if(t===this.personId){this.hideEditForm();return}const o=document.getElementById("save-name-btn"),s=document.getElementById("cancel-edit-btn");o&&s&&(o.disabled=!0,s.disabled=!0,o.classList.add("opacity-50","cursor-not-allowed"),s.classList.add("opacity-50","cursor-not-allowed"));try{const n=await this.renamePersonGlobally(this.personId,t);if(n.success){console.log(`Person name updated from ${this.personId} to: ${t}`);const i=`/person-photos.html?id=${encodeURIComponent(t)}`;window.location.href=i}else this.showError(n.reason||"Failed to save name. Please try again."),o&&s&&(o.disabled=!1,s.disabled=!1,o.classList.remove("opacity-50","cursor-not-allowed"),s.classList.remove("opacity-50","cursor-not-allowed"))}catch(n){console.error("Failed to save person name:",n),this.showError(n instanceof Error?n.message:"Failed to save name. Please try again."),o&&s&&(o.disabled=!1,s.disabled=!1,o.classList.remove("opacity-50","cursor-not-allowed"),s.classList.remove("opacity-50","cursor-not-allowed"))}}async renamePersonGlobally(e,t){const o=new FormData;o.append("old_person_id",e),o.append("new_person_id",t);try{const s=await I(l.TAG_PERSON,{method:"POST",body:o});if(!s.ok){const i=await s.json().catch(()=>({reason:"Network error or invalid JSON response"}));throw new Error(i.reason||`Error ${s.status}: ${s.statusText}`)}const n=await s.json();return{success:n.success||!1,reason:n.reason}}catch(s){throw console.error("Error renaming person:",s),s}}showLoading(e){const t=document.getElementById("loading-indicator");document.getElementById("photo-grid"),t&&(e?(t.classList.remove("hidden"),t.classList.add("flex")):(t.classList.add("hidden"),t.classList.remove("flex")))}showError(e){const t=document.getElementById("error-display"),o=document.getElementById("error-text");t&&o&&(o.textContent=e,t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("hidden")},5e3))}}document.addEventListener("DOMContentLoaded",()=>{new c});window.personPhotosApp=c;
